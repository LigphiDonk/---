# 防投毒功能测试和可视化

本文档介绍如何使用防投毒功能测试脚本生成可视化图片。

## 功能概述

防投毒功能基于梯度余弦相似度检测，通过比较客户端提交的梯度与平均梯度的相似度，识别可能被投毒的客户端。

主要功能包括：
- 模拟不同类型的梯度投毒攻击
- 计算客户端梯度之间的余弦相似度
- 可视化余弦相似度矩阵
- 可视化防投毒检测结果
- 评估不同阈值对检测性能的影响

## 使用方法

### 运行简单测试

```bash
python -m federated_learning.poison_detection_test
```

这将运行简单的防投毒测试，生成两个主要的可视化图片：
- `results/cosine_similarity_matrix.png`: 客户端梯度之间的余弦相似度矩阵
- `results/poison_detection_results.png`: 防投毒检测结果可视化

### 运行完整测试

如需运行完整测试，评估不同投毒类型、强度和阈值的影响，请修改`poison_detection_test.py`文件中的`main`函数，取消注释完整测试部分。

## 可视化图片说明

### 余弦相似度矩阵

余弦相似度矩阵展示了各客户端梯度之间的相似度关系。正常客户端之间的梯度通常具有较高的相似度，而被投毒的客户端梯度与正常客户端梯度的相似度较低。

### 防投毒检测结果

防投毒检测结果图展示了每个客户端梯度与平均梯度的余弦相似度，以及检测结果：
- 蓝色柱状图表示正常客户端
- 红色柱状图表示被投毒的客户端
- 黑色"X"标记表示被检测为投毒的客户端
- 红色虚线表示相似度阈值

## 参数调整

可以调整以下参数来优化防投毒检测效果：

1. 相似度阈值（`similarity_threshold`）：
   - 较高的阈值会减少误报，但可能增加漏报
   - 较低的阈值会增加误报，但可能减少漏报

2. 投毒类型（`poison_type`）：
   - `random`: 添加随机噪声
   - `invert`: 反转梯度方向
   - `constant`: 将梯度设为固定值

3. 投毒强度（`poison_scale`）：
   - 较高的强度使投毒更容易被检测
   - 较低的强度使投毒更隐蔽

## 集成到联邦学习系统

防投毒功能已集成到联邦学习系统中，可以通过配置文件启用：

```python
# 在config.py中设置
poison_detection_config = {
    "enabled": True,  # 是否启用防投毒
    "similarity_threshold": 0.85,  # 余弦相似度阈值
}
```

在服务器聚合梯度前，系统会自动检测并过滤掉可能被投毒的客户端梯度。
